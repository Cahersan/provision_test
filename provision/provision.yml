---
- hosts: all
  vars_files:
    - vars.yml

  tasks:
  - name: Create a directory for django apps.
    file: state=directory path={{apps_root}}

  - name: Create a virtualenv directory in django apps directory.
    file: state=directory path={{venv_path}}

  - name: Install required system packages.
    apt: pkg={{item}} state=installed update-cache=yes
    with_items: system_packages

  - name: Install easy_install packages
    easy_install: name={{item}}
    with_items: easy_install_packages

  - name: Install Python Packages
    pip: name={{item}} virtualenv={{venv_path}}
    with_items: python_packages

#  - name: Start django project
#    shell: "{{apps_root}}/env/bin/django-admin.py startproject {{project_name}} chdir={{apps_root}} creates={{apps_root}}/{{project_name}}"

#  - name: Start django app 
#    shell: "{{apps_root}}/env/bin/django-admin.py startapp {{app_name}} chdir={{apps_root}}/{{project_name}} creates={{apps_root}}/{{project_name}}/{{app_name}}"
  - name: Clone Django project from repo
    git: repo={{remote_repository}} dest={{repository_root}}

  - name: Copy base.py settings to new project
    copy: src=conf/base.py dest={{configuration_root}}/settings

  - name: Copy production.py settings to new project
    copy: src=conf/production.py dest={{configuration_root}}/settings

  - name: Install project requirements
    pip: requirements={{repository_root}}/requirements/production.txt virtualenv={{venv_path}}

  - name: setup pg_hba file
    copy: src=conf/pg_hba.conf dest=/etc/postgresql/9.1/main/pg_hba.conf owner=postgres group=postgres mode=0640
    register: pg_file

  - name: reload postgres if it changed
    service: name=postgresql state=reloaded enabled=yes
    when: pg_file.changed

  - name: Create postgreSQL database
    postgresql_db: name=mydatabase

  - name: Create postgreSQL user
    postgresql_user: db=mydatabase name=mydatabaseuser password=mypassword priv=ALL

  - name: Sync database
    django_manage: app_path={{project_root}} command=syncdb virtualenv={{venv_path}} settings={{project_name}}.settings.production

  - name: Copy initial_data.json
    copy: src=conf/initial_data.json dest={{project_root}}
  
  - name: Load superuser information and other from initial_data.json
    django_manage: command=loaddata app_path={{project_root}} fixtures=initial_data.json virtualenv={{venv_path}} settings={{project_name}}.settings.production

  - name: copy nginx configuration file
    copy: src=conf/nginx.conf dest=/etc/nginx/sites-enabled/
    notify: restart nginx

  - name: copy gunicorn configuration
    copy: src=conf/gunicorn_init.conf dest=/etc/init
    notify: restart gunicorn

  handlers:
    - include: handlers.yml
